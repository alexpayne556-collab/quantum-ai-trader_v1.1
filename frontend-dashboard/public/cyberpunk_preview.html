<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cyberpunk Trading Preview</title>
    <style>
      :root{
        --bg:#0a0e27;--bg2:#0e1435;--grid:#13203b;--text:#e6f1ff;--cyan:#00d9ff;--pink:#ff006e;--green:#00ff88;--accent:#ffd60a
      }
      html,body{height:100%}
      body{
        margin:0;color:var(--text);background:
        radial-gradient(1200px 600px at 15% 10%, #0f1a4a 0%, transparent 60%),
        radial-gradient(900px 600px at 85% 0%, #1a0042 0%, transparent 55%),
        var(--bg);
        font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial
      }
      .cyber-shell{position:relative;width:min(1600px,96vw);height:min(900px,88vh);margin:3vh auto;border-radius:16px;background:linear-gradient(180deg,var(--bg2),var(--bg));border:1px solid #1a2547;box-shadow:0 0 0 1px #1a2547 inset,0 0 40px #00d9ff22,0 0 80px #ff006e11;overflow:hidden}
      .hud{position:absolute;inset:10px 10px auto 10px;display:flex;gap:10px;align-items:center;font-size:12px;opacity:.95;z-index:2}
      .badge{color:var(--bg);background:var(--green);padding:6px 10px;border-radius:8px;font-weight:800;letter-spacing:.08em}
      .title{margin-left:6px;font-weight:700;color:var(--text);text-shadow:0 0 12px #00d9ff55}
      .edge{margin-left:auto;color:var(--accent);font-weight:700}
      .chart-host{position:absolute;inset:0}
      .glow{position:absolute;inset:0;pointer-events:none;box-shadow:0 0 120px 20px #00d9ff22 inset,0 0 160px 30px #ff006e11 inset}
      .footer{position:absolute;bottom:8px;left:12px;right:12px;display:flex;justify-content:space-between;opacity:.8;font-size:12px}
    </style>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  </head>
  <body>
    <div class="cyber-shell">
      <div class="hud">
        <div class="badge">ALGO LIVE</div>
        <div class="title">Quantum Trader â€¢ Cyberpunk Preview</div>
        <div class="edge">Edge: 72</div>
      </div>
      <div id="chart" class="chart-host"></div>
      <div class="glow"></div>
      <div class="footer"><span id="status">Data: auto</span><span>Theme: Cyberpunk</span></div>
    </div>

    <script>
      const { createChart, CrosshairMode } = window.LightweightCharts;

      function generateCandles(count = 240){
        const out=[]; let t = Math.floor(Date.now()/1000) - count*24*3600; let price=300;
        for(let i=0;i<count;i++){
          const drift=(Math.sin(i/15)+Math.cos(i/30))*0.6; const vol=1.2+Math.abs(Math.sin(i/10))*2.5;
          const change=drift+(Math.random()-0.5)*vol; const open=price; const close=Math.max(5, open+change);
          const high=Math.max(open, close)+Math.random()*(vol*0.8); const low=Math.min(open, close)-Math.random()*(vol*0.8);
          t += 24*3600; out.push({ time:t, open, high, low, close }); price=close;
        }
        return out;
      }
      function ema(values, period){ const k=2/(period+1); let e=values[0]; const res=[e];
        for(let i=1;i<values.length;i++){ e = values[i]*k + e*(1-k); res.push(e);} return res;
      }

      const container = document.getElementById('chart');
      const chart = createChart(container, {
        autoSize:true,
        layout:{ background:{ type:'solid', color:'#0a0e27' }, textColor:'#ccd6f6' },
        grid:{ vertLines:{ color:'#13203b' }, horzLines:{ color:'#13203b' } },
        crosshair:{ mode: CrosshairMode.Normal },
        rightPriceScale:{ borderColor:'#1a2547' },
        timeScale:{ borderColor:'#1a2547' },
      });

      const candleSeries = chart.addCandlestickSeries({
        upColor:'#00ff88', downColor:'#ff006e', borderUpColor:'#00ff88', borderDownColor:'#ff006e', wickUpColor:'#00ff88', wickDownColor:'#ff006e'
      });

      function attach(candles){
        candleSeries.setData(candles);
        const closes = candles.map(c=>c.close);
        const ema13 = ema(closes,13), ema21 = ema(closes,21), ema55 = ema(closes,55);
        const s13 = chart.addLineSeries({ color:'#00ccff', lineWidth:1 });
        const s21 = chart.addLineSeries({ color:'#0066ff', lineWidth:1 });
        const s55 = chart.addLineSeries({ color:'#6a00ff', lineWidth:2 });
        s13.setData(candles.map((c,i)=>({ time:c.time, value:ema13[i] })));
        s21.setData(candles.map((c,i)=>({ time:c.time, value:ema21[i] })));
        s55.setData(candles.map((c,i)=>({ time:c.time, value:ema55[i] })));

        const last = candles[candles.length-1];
        const forecast = []; let p = last.close; const lastTime = typeof last.time==='number'? last.time : Math.floor(Date.now()/1000);
        for(let i=1;i<=24;i++){ p = p*(1+0.0005*i) + Math.sin(i/3)*0.6; forecast.push({ time:lastTime + i*24*3600, value:p }); }
        const f = chart.addLineSeries({ color:'#00d9ff', lineWidth:2, lineStyle:1 }); f.setData(forecast);
        const cone = chart.addAreaSeries({ topColor:'rgba(0,217,255,0.20)', bottomColor:'rgba(0,217,255,0.02)', lineColor:'rgba(0,0,0,0)', lineWidth:0 });
        cone.setData(forecast.map((pt,i)=>({ time:pt.time, value: pt.value*(1 + 0.02 + i*0.0005) })));
        chart.timeScale().fitContent();
      }

      // Try backend first; fall back to mock
      const statusEl = document.getElementById('status');
      fetch('http://127.0.0.1:8000/api/ohlcv?ticker=SPY&limit=240', { mode:'cors' })
        .then(r => r.ok ? r.json() : Promise.reject(new Error('http error')))
        .then(rows => {
          // Accept YYYY-MM-DD by converting to BusinessDay objects for consistency
          const candles = rows.map(r=>{
            const [y,m,d] = String(r.time).split('-').map(Number);
            return { time:{ year:y, month:m, day:d }, open:+r.open, high:+r.high, low:+r.low, close:+r.close };
          });
          statusEl.textContent = 'Data: backend (SPY)';
          attach(candles);
        })
        .catch(() => {
          statusEl.textContent = 'Data: mock (offline)';
          attach(generateCandles(240));
        });
    </script>
  </body>
  </html>
